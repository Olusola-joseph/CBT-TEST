<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test English Pages Count</title>
</head>
<body>
    <h1>Test English Pages Count</h1>
    <div id="output"></div>

    <script>
        // Mock database object to avoid errors
        const examDB = {
            db: true,
            init: () => Promise.resolve(),
            getQuestionsBySubject: () => Promise.resolve([]),
            addQuestions: () => Promise.resolve()
        };

        // Include the English script content
        class EnglishCBTExamApp {
            constructor() {
                this.questions = [];
                this.selectedSubject = 'English';
                this.selectedYear = 'jamb_2010';
            }

            // Reorganize English questions to follow the sequence: passage -> questions, instruction -> questions
            reorganizeEnglishQuestions(subjectData) {
                let reorganizedQuestions = [];
                let currentId = 1;

                // Process questions in the order they appear in the original questions array
                // For each question, check if it belongs to a passage or instruction and handle accordingly
                if (subjectData.questions) {
                    // Create maps of passage and instruction questions to process them in the intended order
                    const passageQuestionMap = {};
                    const instructionQuestionMap = {};
                    const standaloneQuestions = [];

                    // Group questions by their associated passage or instruction
                    subjectData.questions.forEach(question => {
                        if (question.passageId) {
                            if (!passageQuestionMap[question.passageId]) {
                                passageQuestionMap[question.passageId] = [];
                            }
                            passageQuestionMap[question.passageId].push(question);
                        } else if (question.instructionId) {
                            if (!instructionQuestionMap[question.instructionId]) {
                                instructionQuestionMap[question.instructionId] = [];
                            }
                            instructionQuestionMap[question.instructionId].push(question);
                        } else {
                            standaloneQuestions.push(question);
                        }
                    });

                    // Process passages in order (I, II, III, IV, etc.)
                    if (subjectData.passages && subjectData.passages.length > 0) {
                        // Sort passages to ensure correct order
                        const sortedPassages = [...subjectData.passages].sort((a, b) => {
                            // Sort by Roman numerals: I, II, III, IV, etc.
                            const romanToNum = { 'I': 1, 'II': 2, 'III': 3, 'IV': 4, 'V': 5, 'VI': 6, 'VII': 7, 'VIII': 8, 'IX': 9, 'X': 10 };
                            const numA = romanToNum[a.id.replace('Passage ', '')];
                            const numB = romanToNum[b.id.replace('Passage ', '')];
                            return (numA || 0) - (numB || 0);
                        });

                        sortedPassages.forEach(passage => {
                            if (passageQuestionMap[passage.id] && passageQuestionMap[passage.id].length > 0) {
                                // Add the passage as a content page
                                const passageContent = {
                                    id: currentId++,
                                    type: 'passage',
                                    title: passage.id,
                                    text: passage.text,
                                    question: `<div class="english-passage"><h4>${passage.id}</h4><div class="passage-content">${passage.text}</div><div class="passage-note">Please read the above passage carefully before answering the questions that follow.</div></div>`,
                                    options: [{ id: "CONTINUE", text: "Continue to questions" }],
                                    correctAnswer: "CONTINUE",
                                    explanation: "This is a passage. Please read carefully before answering the questions that follow."
                                };
                                reorganizedQuestions.push(passageContent);

                                // Add questions related to this passage
                                passageQuestionMap[passage.id].forEach(question => {
                                    // Update the question ID to the sequential ID
                                    const modifiedQuestion = {
                                        ...question,
                                        id: currentId++
                                    };
                                    reorganizedQuestions.push(modifiedQuestion);
                                });
                            }
                        });
                    }

                    // Process instructions in order (1, 2, 3, etc.)
                    if (subjectData.instructions && subjectData.instructions.length > 0) {
                        // Sort instructions to ensure correct order
                        const sortedInstructions = [...subjectData.instructions].sort((a, b) => {
                            const numA = parseInt(a.id.replace('Instruction ', ''));
                            const numB = parseInt(b.id.replace('Instruction ', ''));
                            return numA - numB;
                        });

                        sortedInstructions.forEach(instruction => {
                            if (instructionQuestionMap[instruction.id] && instructionQuestionMap[instruction.id].length > 0) {
                                // Add the instruction as a content page
                                const instructionContent = {
                                    id: currentId++,
                                    type: 'instruction',
                                    title: instruction.id,
                                    text: instruction.text,
                                    question: `<div class="english-instruction"><h4>${instruction.id}</h4><p>${instruction.text}</p></div>`,
                                    options: [{ id: "CONTINUE", text: "Continue to questions" }],
                                    correctAnswer: "CONTINUE",
                                    explanation: "Please read the instructions carefully before attempting the questions that follow."
                                };
                                reorganizedQuestions.push(instructionContent);
                                
                                // Add questions related to this instruction
                                instructionQuestionMap[instruction.id].forEach(question => {
                                    // Update the question ID to the sequential ID and preserve passageId if it exists
                                    const modifiedQuestion = {
                                        ...question,
                                        id: currentId++
                                    };
                                    reorganizedQuestions.push(modifiedQuestion);
                                });
                            }
                        });
                    }

                    // Add any remaining standalone questions
                    standaloneQuestions.forEach(question => {
                        const modifiedQuestion = {
                            ...question,
                            id: currentId++
                        };
                        reorganizedQuestions.push(modifiedQuestion);
                    });
                }

                console.log(`Reorganized English questions: ${reorganizedQuestions.length} total items`);
                console.log(`Original question count: ${subjectData.questions ? subjectData.questions.length : 0}`);
                console.log(`Passages count: ${subjectData.passages ? subjectData.passages.length : 0}`);
                console.log(`Instructions count: ${subjectData.instructions ? subjectData.instructions.length : 0}`);
                return reorganizedQuestions;
            }
        }

        // Test function to load and process the English questions
        async function testEnglishPages() {
            try {
                // Load the English questions JSON
                const response = await fetch('src/data/subjects/english_questions_jamb_2010.json');
                const subjectData = await response.json();
                
                // Create an instance of the app
                const app = new EnglishCBTExamApp();
                
                // Reorganize the questions
                const reorganizedQuestions = app.reorganizeEnglishQuestions(subjectData);
                
                // Display results
                const output = document.getElementById('output');
                output.innerHTML = `
                    <h2>English Questions Analysis:</h2>
                    <p><strong>Original questions:</strong> ${subjectData.questions ? subjectData.questions.length : 0}</p>
                    <p><strong>Passages:</strong> ${subjectData.passages ? subjectData.passages.length : 0}</p>
                    <p><strong>Instructions:</strong> ${subjectData.instructions ? subjectData.instructions.length : 0}</p>
                    <p><strong>Total reorganized items:</strong> ${reorganizedQuestions.length}</p>
                    <p><strong>Expected total (4 passages + 9 instructions + 100 questions):</strong> 113</p>
                    
                    <h3>Breakdown by type:</h3>
                    <ul>
                        ${reorganizedQuestions.map((q, i) => `<li>${i+1}. ${q.type || 'question'} - ID: ${q.id}</li>`).join('')}
                    </ul>
                `;
                
                console.log("Reorganized questions:", reorganizedQuestions);
            } catch (error) {
                console.error('Error loading test:', error);
                document.getElementById('output').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }

        // Run the test when the page loads
        window.onload = testEnglishPages;
    </script>
</body>
</html>